<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="./stylesheets/output.css" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css2?family=Asap&display=swap"
      rel="stylesheet"
    />
    <title>PediCare+ - Consultas</title>
  </head>

  <body class="bg-[#f8f7f4] min-h-screen flex flex-col items-center">
    <!-- Header -->
    <header class="bg-[#f7f5ee] w-full py-4 shadow">
      <h1 class="text-2xl font-bold text-center text-[#3b413c]">PediCare+</h1>
    </header>

    <!-- Container principal -->
    <div
      class="flex flex-col md:flex-row w-full max-w-5xl mt-10 bg-[#fff8f1] p-6 rounded-lg shadow-md"
    >
      <!-- Consultas Agendadas -->
      <div
        class="w-full md:w-1/2 pr-4 border-b md:border-b-0 md:border-r border-[#e5e5e5]"
      >
        <h2 class="text-lg font-semibold text-[#3b413c] mb-4">
          Consultas Agendadas
        </h2>
        <div id="consultas-container">
          <% if (consultas && consultas.length > 0) { %> <%
          consultas.forEach(consulta => { %>
          <div class="bg-white p-4 rounded-lg shadow-md mb-4">
            <p class="font-medium text-gray-700">
              <%= consulta.medico_nome %> - <%= consulta.especialidade %>
            </p>
            <p class="text-sm text-gray-500">
              <%= new Date(consulta.data_consulta).toLocaleString() %>
            </p>
          </div>
          <% }) %> <% } else { %>
          <p class="text-gray-500">Nenhuma consulta agendada.</p>
          <% } %>
        </div>
      </div>

      <!-- Cancelar ou Reagendar -->
      <div class="w-full md:w-1/2 pl-4 mt-6 md:mt-0">
        <h2 class="text-lg font-semibold text-[#3b413c] mb-4">
          Cancelar ou Reagendar
        </h2>
        <form id="form-reagendar" class="space-y-4">
          <div>
            <label
              for="consultaSelecionada"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Selecione a consulta agendada:
            </label>
            <select
              id="consultaSelecionada"
              name="consultaId"
              class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500"
            >
              <% if (consultas && consultas.length > 0) { %> <%
              consultas.forEach(consulta => { %>
              <option value="<%= consulta.consulta_id %>">
                <%= consulta.medico_nome %> - <%= new
                Date(consulta.data_consulta).toLocaleString() %>
              </option>
              <% }) %> <% } else { %>
              <option disabled>Nenhuma consulta disponível</option>
              <% } %>
            </select>
          </div>

          <div>
            <label
              for="motivoCancelamento"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Motivo do cancelamento:
            </label>
            <textarea
              id="motivoCancelamento"
              name="motivo"
              rows="3"
              class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500"
            ></textarea>
          </div>

          <div>
            <button
              type="button"
              id="cancelarConsulta"
              class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700"
            >
              Cancelar Consulta
            </button>
          </div>

          <div>
            <label
              for="novaData"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Nova Data:
            </label>
            <input
              type="date"
              id="novaData"
              name="novaData"
              class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Selecione o novo horário:</label
            >
            <div id="horarios" class="flex gap-2">
              <!-- Horários disponíveis -->
            </div>
          </div>

          <div>
            <button
              type="button"
              id="reagendarConsulta"
              class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700"
            >
              Reagendar Consulta
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const pacienteId = "<%= pacienteId %>"; // ID do paciente
      const consultasContainer = document.getElementById("consultas-container");
      const consultaSelecionada = document.getElementById(
        "consultaSelecionada"
      );
      const motivoCancelamento = document.getElementById("motivoCancelamento");
      const novaData = document.getElementById("novaData");
      const horariosContainer = document.getElementById("horarios");

      // Função para carregar horários disponíveis
      async function carregarHorariosDisponiveis() {
        try {
          const response = await fetch(
            `/consultas/horarios?pacienteId=${pacienteId}`
          );
          if (!response.ok)
            throw new Error("Erro ao carregar horários disponíveis.");

          const horarios = await response.json();
          horariosContainer.innerHTML = horarios
            .map(
              (horario) => `
                    <button type="button" class="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600" onclick="selecionarHorario('${
                      horario.horario
                    }')" ${
                !horario.disponivel ? 'disabled class="opacity-50"' : ""
              }>
                        ${horario.horario}
                    </button>
                `
            )
            .join("");
        } catch (error) {
          console.error(error);
          alert("Erro ao carregar horários disponíveis.");
        }
      }

      let horarioSelecionado = null;
      function selecionarHorario(horario) {
        horarioSelecionado = horario;
        alert(`Horário ${horario} selecionado!`);
      }

      // Função para cancelar consulta
      async function cancelarConsulta() {
        try {
          const consultaId = consultaSelecionada.value;
          const motivo = motivoCancelamento.value;

          const response = await fetch("/consultas/cancelar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ consultaId, motivo, pacienteId }),
          });

          if (!response.ok) throw new Error("Erro ao cancelar consulta.");

          alert("Consulta cancelada com sucesso!");
          location.reload();
        } catch (error) {
          console.error(error);
          alert("Erro ao cancelar consulta.");
        }
      }

      // Função para reagendar consulta
      async function reagendarConsulta() {
        try {
          const consultaId = consultaSelecionada.value;
          const novaDataHora = `${novaData.value}T${horarioSelecionado}`;

          const response = await fetch("/consultas/reagendar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              consultaId,
              novaData: novaDataHora,
              pacienteId,
            }),
          });

          if (!response.ok) throw new Error("Erro ao reagendar consulta.");

          alert("Consulta reagendada com sucesso!");
          location.reload();
        } catch (error) {
          console.error(error);
          alert("Erro ao reagendar consulta.");
        }
      }

      // Adicionar eventos aos botões
      document
        .getElementById("cancelarConsulta")
        .addEventListener("click", cancelarConsulta);
      document
        .getElementById("reagendarConsulta")
        .addEventListener("click", reagendarConsulta);

      // Inicializar a página
      carregarHorariosDisponiveis();
    </script>
  </body>
</html>
