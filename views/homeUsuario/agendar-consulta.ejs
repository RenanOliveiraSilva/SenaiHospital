<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/stylesheets/output.css" />
    <title>PediCare+ - Consultas</title>
    <style>
        .selected {
            border: 2px solid #465c47 !important;
            background-color: #f4f4f4 !important;
        }
        .disabled {
            background-color: #d3d3d3 !important;
            cursor: not-allowed !important;
        }
    </style>
</head>
<body class="bg-[#F9F8F3] font-sans">
    <div class="w-3/5 mx-auto p-6">
        <!-- Cabeçalho -->
        <header class="bg-[#EAE5DA] p-4 rounded-md shadow-md mb-6 text-center">
            <h1 class="text-3xl font-bold text-[#465C47]">PediCare+</h1>
        </header>

        <!-- Seção de locais -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold text-[#465C47] mb-4">
                Escolha o local da consulta
            </h2>
            <div id="locais-container" class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                <!-- Locais fixos -->
                <div class="bg-[#FAF3E9] cursor-pointer hover:scale-105 p-4 rounded-md shadow-md text-center text-gray-500 flex flex-col items-center justify-center transform transition duration-200" onclick="selectLocal(1)">
                    <p class="font-semibold text-[#465C47]">Guará - SP</p>
                </div>
            </div>
        </section>

        <!-- Seção de Data e Hora -->
        <section class="mb-8">
            <h3 class="text-xl font-semibold text-[#465C47] mb-4">
                Escolha uma data e horário
            </h3>
            <div class="flex gap-4 items-center">
                <input
                    type="date"
                    id="data-consulta"
                    class="p-3 border rounded-md text-gray-700"
                    onchange="updateMedicos()"
                />
                <div id="horarios-container" class="flex flex-wrap gap-2">
                    <!-- Horários serão injetados aqui -->
                </div>
            </div>
        </section>

        <!-- Médicos Disponíveis -->
        <section class="mb-8">
            <h3 class="text-xl font-semibold text-[#465C47] mb-4">
                Médicos disponíveis
            </h3>
            <div id="medicos-container" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <p class="text-gray-500 col-span-full">
                    Selecione o local e a data para exibir os médicos disponíveis.
                </p>
            </div>
        </section>

        <!-- Botão de Confirmação -->
        <div class="flex justify-end">
            <button
                id="confirmar-btn"
                class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-md cursor-not-allowed"
                disabled
                onclick="confirmarConsulta()"
            >
                Confirmar Consulta
            </button>
        </div>
    </div>

    <script>
        let selectedPolo = "";
        let selectedHorario = "";
        let selectedMedico = "";

        // Função para selecionar o local da consulta
        function selectLocal(localId) {
            clearSelected("polo");
            selectedPolo = localId;
            const locais = document.querySelectorAll("#locais-container div");
            locais.forEach(local => {
                if (local.onclick) {
                    local.classList.remove("selected");
                }
            });
            locais[localId - 1].classList.add("selected");
            updateMedicos();
        }

        // Atualização de médicos disponíveis
        async function updateMedicos() {
            const data = document.getElementById("data-consulta").value;
            const medicosContainer = document.getElementById("medicos-container");
            medicosContainer.innerHTML = "";

            if (selectedPolo && data) {
                try {
                    const response = await fetch(`/medicos-disponiveis?data=${data}&local=${selectedPolo}`);
                    const medicos = await response.json();

                    medicos.forEach((medico) => {
                        const card = document.createElement("div");
                        card.className =
                            "bg-[#FAF3E9] p-4 rounded-md shadow-md text-center text-[#465C47] font-medium cursor-pointer hover:bg-[#EAE5DA] transform transition duration-200";
                        card.innerHTML = `<p>${medico.nome}</p>`;
                        card.onclick = () => toggleSelection(card, "medico", medico.id);
                        medicosContainer.appendChild(card);
                    });
                } catch (error) {
                    console.error('Erro ao buscar médicos:', error);
                    medicosContainer.innerHTML = `<p class="text-gray-500 col-span-full">Erro ao carregar médicos.</p>`;
                }
            } else {
                medicosContainer.innerHTML = `<p class="text-gray-500 col-span-full">Selecione o local e a data para exibir os médicos disponíveis.</p>`;
            }
        }

        // Buscar horários disponíveis para um médico específico
        async function updateHorarios(medicoId) {
            const data = document.getElementById("data-consulta").value;
            const horariosContainer = document.getElementById("horarios-container");
            horariosContainer.innerHTML = "";

            if (data && medicoId) {
                try {
                    const response = await fetch(`/horarios-disponiveis?data=${data}&medicoId=${medicoId}`);
                    const horarios = await response.json();

                    horarios.forEach((horario) => {
                        const button = document.createElement("button");
                        button.className =
                            "bg-[#FAF3E9] p-2 w-20 text-center rounded-md shadow-md text-[#465C47] font-medium cursor-pointer hover:bg-[#EAE5DA] transition duration-200 text-sm";
                        button.innerText = `${horario}:00`;
                        button.onclick = () => toggleSelection(button, "horario", horario);
                        horariosContainer.appendChild(button);
                    });
                } catch (error) {
                    console.error('Erro ao buscar horários:', error);
                    horariosContainer.innerHTML = `<p class="text-gray-500 col-span-full">Erro ao carregar horários.</p>`;
                }
            }
        }

        // Alternar seleção
        function toggleSelection(element, type, value) {
            if (element.classList.contains("selected")) {
                element.classList.remove("selected");
                if (type === "polo") selectedPolo = "";
                if (type === "horario") selectedHorario = "";
                if (type === "medico") selectedMedico = "";
            } else {
                clearSelected(type);
                element.classList.add("selected");
                if (type === "polo") selectedPolo = value;
                if (type === "horario") selectedHorario = value;
                if (type === "medico") {
                    selectedMedico = value;
                    updateHorarios(value); // Atualizar horários ao selecionar um médico
                }
            }
            updateConfirmButton();
        }

        // Limpar seleção anterior
        function clearSelected(type) {
            const selector =
                type === "polo"
                    ? "#locais-container div"
                    : type === "horario"
                    ? "#horarios-container button"
                    : "#medicos-container div";
            document.querySelectorAll(selector).forEach((element) => {
                element.classList.remove("selected");
            });
        }

        // Atualização do botão de confirmação
        function updateConfirmButton() {
            const btn = document.getElementById("confirmar-btn");
            btn.disabled = !(selectedPolo && selectedHorario && selectedMedico);
            btn.classList.toggle("bg-green-800", !btn.disabled);
            btn.classList.toggle("cursor-pointer", !btn.disabled);
            btn.classList.toggle("cursor-not-allowed", btn.disabled);
            btn.classList.toggle("bg-gray-400", btn.disabled);
        }

        // Confirmação de consulta
        async function confirmarConsulta() {
            const data = document.getElementById("data-consulta").value;
            try {
                const response = await fetch('/agendar-consulta', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data,
                        horario: selectedHorario,
                        medicoId: selectedMedico,
                        localConsulta: selectedPolo,
                        pacienteId: 1 // Troque pelo ID real do paciente
                    }),
                });

                if (!response.ok) {
                    throw new Error('Erro ao agendar consulta.');
                }

                alert('Consulta confirmada com sucesso!');
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao confirmar consulta. Tente novamente.');
            }
        }

    </script>
</body>
</html>